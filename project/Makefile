# PMCå…¨æµç¨‹ç®¡ç†ç³»ç»Ÿ - Makefile
# ä½¿ç”¨è¯´æ˜: make <target>

.PHONY: help build up down restart logs clean dev-up dev-down dev-logs test lint format

# é»˜è®¤ç›®æ ‡
help:
	@echo "PMCå…¨æµç¨‹ç®¡ç†ç³»ç»Ÿ - å¯ç”¨å‘½ä»¤:"
	@echo ""
	@echo "ç”Ÿäº§ç¯å¢ƒ:"
	@echo "  build      - æ„å»ºç”Ÿäº§ç¯å¢ƒé•œåƒ"
	@echo "  up         - å¯åŠ¨ç”Ÿäº§ç¯å¢ƒæœåŠ¡"
	@echo "  down       - åœæ­¢ç”Ÿäº§ç¯å¢ƒæœåŠ¡"
	@echo "  restart    - é‡å¯ç”Ÿäº§ç¯å¢ƒæœåŠ¡"
	@echo "  logs       - æŸ¥çœ‹ç”Ÿäº§ç¯å¢ƒæ—¥å¿—"
	@echo ""
	@echo "å¼€å‘ç¯å¢ƒ:"
	@echo "  dev-build  - æ„å»ºå¼€å‘ç¯å¢ƒé•œåƒ"
	@echo "  dev-up     - å¯åŠ¨å¼€å‘ç¯å¢ƒæœåŠ¡"
	@echo "  dev-down   - åœæ­¢å¼€å‘ç¯å¢ƒæœåŠ¡"
	@echo "  dev-restart- é‡å¯å¼€å‘ç¯å¢ƒæœåŠ¡"
	@echo "  dev-logs   - æŸ¥çœ‹å¼€å‘ç¯å¢ƒæ—¥å¿—"
	@echo ""
	@echo "ä»£ç è´¨é‡:"
	@echo "  test       - è¿è¡Œæµ‹è¯•"
	@echo "  lint       - ä»£ç æ£€æŸ¥"
	@echo "  format     - ä»£ç æ ¼å¼åŒ–"
	@echo ""
	@echo "å·¥å…·:"
	@echo "  clean      - æ¸…ç†Dockerèµ„æº"
	@echo "  backup     - å¤‡ä»½æ•°æ®åº“"
	@echo "  restore    - æ¢å¤æ•°æ®åº“"
	@echo "  shell-be   - è¿›å…¥åç«¯å®¹å™¨"
	@echo "  shell-fe   - è¿›å…¥å‰ç«¯å®¹å™¨"
	@echo "  shell-db   - è¿›å…¥æ•°æ®åº“å®¹å™¨"

# ç”Ÿäº§ç¯å¢ƒå‘½ä»¤
build:
	@echo "ğŸ”¨ æ„å»ºç”Ÿäº§ç¯å¢ƒé•œåƒ..."
	docker-compose build --no-cache

up:
	@echo "ğŸš€ å¯åŠ¨ç”Ÿäº§ç¯å¢ƒæœåŠ¡..."
	docker-compose up -d
	@echo "âœ… æœåŠ¡å·²å¯åŠ¨ï¼Œè®¿é—®åœ°å€:"
	@echo "   å‰ç«¯: http://localhost:3000"
	@echo "   åç«¯: http://localhost:8000"
	@echo "   æ–‡æ¡£: http://localhost:8000/docs"

down:
	@echo "ğŸ›‘ åœæ­¢ç”Ÿäº§ç¯å¢ƒæœåŠ¡..."
	docker-compose down

restart:
	@echo "ğŸ”„ é‡å¯ç”Ÿäº§ç¯å¢ƒæœåŠ¡..."
	docker-compose restart

logs:
	@echo "ğŸ“‹ æŸ¥çœ‹ç”Ÿäº§ç¯å¢ƒæ—¥å¿—..."
	docker-compose logs -f

# å¼€å‘ç¯å¢ƒå‘½ä»¤
dev-build:
	@echo "ğŸ”¨ æ„å»ºå¼€å‘ç¯å¢ƒé•œåƒ..."
	docker-compose -f docker-compose.dev.yml build --no-cache

dev-up:
	@echo "ğŸš€ å¯åŠ¨å¼€å‘ç¯å¢ƒæœåŠ¡..."
	docker-compose -f docker-compose.dev.yml up -d
	@echo "âœ… å¼€å‘ç¯å¢ƒå·²å¯åŠ¨ï¼Œè®¿é—®åœ°å€:"
	@echo "   å‰ç«¯: http://localhost:3001"
	@echo "   åç«¯: http://localhost:8001"
	@echo "   æ–‡æ¡£: http://localhost:8001/docs"
	@echo "   æ•°æ®åº“ç®¡ç†: http://localhost:5050"
	@echo "   Redisç®¡ç†: http://localhost:8081"

dev-down:
	@echo "ğŸ›‘ åœæ­¢å¼€å‘ç¯å¢ƒæœåŠ¡..."
	docker-compose -f docker-compose.dev.yml down

dev-restart:
	@echo "ğŸ”„ é‡å¯å¼€å‘ç¯å¢ƒæœåŠ¡..."
	docker-compose -f docker-compose.dev.yml restart

dev-logs:
	@echo "ğŸ“‹ æŸ¥çœ‹å¼€å‘ç¯å¢ƒæ—¥å¿—..."
	docker-compose -f docker-compose.dev.yml logs -f

# ä»£ç è´¨é‡å‘½ä»¤
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	docker exec pmc_backend_dev pytest -v --cov=app tests/

lint:
	@echo "ğŸ” ä»£ç æ£€æŸ¥..."
	docker exec pmc_backend_dev flake8 app/
	docker exec pmc_backend_dev mypy app/

format:
	@echo "ğŸ¨ ä»£ç æ ¼å¼åŒ–..."
	docker exec pmc_backend_dev black app/
	docker exec pmc_backend_dev isort app/

# å·¥å…·å‘½ä»¤
clean:
	@echo "ğŸ§¹ æ¸…ç†Dockerèµ„æº..."
	docker-compose down -v --rmi all
	docker system prune -f

backup:
	@echo "ğŸ’¾ å¤‡ä»½æ•°æ®åº“..."
	docker exec pmc_postgres pg_dump -U pmc_user pmc_db > backup_$(shell date +%Y%m%d_%H%M%S).sql

restore:
	@echo "ğŸ“¥ æ¢å¤æ•°æ®åº“..."
	@read -p "è¯·è¾“å…¥å¤‡ä»½æ–‡ä»¶è·¯å¾„: " backup_file; \
	docker exec -i pmc_postgres psql -U pmc_user -d pmc_db < $$backup_file

shell-be:
	@echo "ğŸš è¿›å…¥åç«¯å®¹å™¨..."
	docker exec -it pmc_backend bash

shell-fe:
	@echo "ğŸš è¿›å…¥å‰ç«¯å®¹å™¨..."
	docker exec -it pmc_frontend sh

shell-db:
	@echo "ğŸš è¿›å…¥æ•°æ®åº“å®¹å™¨..."
	docker exec -it pmc_postgres psql -U pmc_user -d pmc_db

# å¼€å‘ç¯å¢ƒå®¹å™¨å‘½ä»¤
dev-shell-be:
	@echo "ğŸš è¿›å…¥å¼€å‘åç«¯å®¹å™¨..."
	docker exec -it pmc_backend_dev bash

dev-shell-fe:
	@echo "ğŸš è¿›å…¥å¼€å‘å‰ç«¯å®¹å™¨..."
	docker exec -it pmc_frontend_dev sh

dev-shell-db:
	@echo "ğŸš è¿›å…¥å¼€å‘æ•°æ®åº“å®¹å™¨..."
	docker exec -it pmc_postgres_dev psql -U pmc_user -d pmc_db_dev

# ç›‘æ§å‘½ä»¤
status:
	@echo "ğŸ“Š æœåŠ¡çŠ¶æ€..."
	docker-compose ps

dev-status:
	@echo "ğŸ“Š å¼€å‘ç¯å¢ƒæœåŠ¡çŠ¶æ€..."
	docker-compose -f docker-compose.dev.yml ps

# å¿«é€Ÿå¯åŠ¨å‘½ä»¤
quick-start: build up
	@echo "âš¡ å¿«é€Ÿå¯åŠ¨å®Œæˆï¼"

dev-quick-start: dev-build dev-up
	@echo "âš¡ å¼€å‘ç¯å¢ƒå¿«é€Ÿå¯åŠ¨å®Œæˆï¼"